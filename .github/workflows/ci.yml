name: CI - backend tests

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test-backend:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: [3.7]
    env:
      MJ_ADMIN_TOKEN: ${{ secrets.MJ_ADMIN_TOKEN }}  # set this in repo secrets if admin endpoints are protected
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: ./backend
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt } else { pip install fastapi uvicorn[standard] websocket-client requests pytest }

      - name: Start uvicorn backend (background)
        working-directory: ./backend
        shell: powershell
        run: |
          Write-Host "Starting uvicorn..."
          Start-Process -FilePath python -ArgumentList '-m uvicorn app:app --host 127.0.0.1 --port 8000' -NoNewWindow
          Start-Sleep -s 6
          Write-Host "uvicorn started (background)."

      - name: Run pytest (unit/integration)
        working-directory: ./backend
        shell: powershell
        run: |
          pytest -q --maxfail=1

      - name: Run run_demo_flow (PowerShell) to exercise REST flow
        working-directory: ./backend
        shell: powershell
        run: |
          .\scripts\run_demo_flow.ps1

      - name: Run websocket integration script (Python)
        working-directory: ./backend
        shell: powershell
        run: |
          python .\scripts\ws_test.py

      - name: Upload backend logs (if any)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs
          path: backend/*.log